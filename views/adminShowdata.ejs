<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Admin Dashboard for Student Support System">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon"
        href="https://ik.imagekit.io/7de5cntkw/1692626704665-photoaidcom-cropped%20(1).jpeg?updatedAt=1738048156918"
        type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e6edfa, #f4f7fa);
            min-height: 100vh;
            display: flex;
            color: #1e293b;
        }

        .sidebar {
            width: 250px;
            background: #ffffff;
            padding: 24px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sidebar h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            font-size: 14px;
            color: #64748b;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: #3b82f6;
            color: #ffffff;
        }

        .container {
            flex: 1;
            max-width: 1600px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 32px;
            margin: 16px;
            animation: fadeIn 0.5s ease-in-out;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .description {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            max-width: 600px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .search-bar input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .search-bar button {
            padding: 12px 16px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .search-bar button:hover {
            background: #2563eb;
        }

        .student-details {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
            animation: slideUp 0.5s ease-out;
        }

        .detail-row {
            display: flex;
            background: #f9fafb;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .detail-row:hover {
            transform: translateY(-2px);
        }

        .detail-row label {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            width: 200px;
            flex-shrink: 0;
        }

        .detail-row span,
        .detail-row a {
            font-size: 14px;
            color: #334155;
            word-break: break-word;
            flex: 1;
        }

        .photo-row {
            display: flex;
            align-items: center;
            background: #f9fafb;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .photo-row img {
            width: 80px;
            height: 106px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-left: 32px;
        }

        .download-btn {
            display: none;
            padding: 10px;
            background: #2b6bf4;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            max-width: 300px;
            margin: 16px auto;
            transition: all 0.2s ease;
        }

        .download-btn:hover:not(:disabled) {

            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .error-message {
            display: none;
            text-align: center;
            color: #dc2626;
            font-size: 14px;
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }

            .container {
                margin: 8px;
            }

            .search-bar {
                max-width: 500px;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .sidebar a {
                flex: 1 1 100px;
            }

            .container {
                padding: 16px;
            }

            h1 {
                font-size: 24px;
            }

            .description {
                font-size: 13px;
            }

            .search-bar {
                max-width: 100%;
            }

            .detail-row label {
                width: 150px;
            }
        }

        @media (max-width: 480px) {
            .search-bar button {
                font-size: 12px;
                padding: 10px;
            }

            .download-btn {
                font-size: 14px;
                padding: 12px;
            }

            .photo-row img {
                width: 60px;
                height: 80px;
            }

            .detail-row label {
                width: 120px;
                font-size: 12px;
            }

            .detail-row span,
            .detail-row a {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <br>
        <h2>Admin Panel</h2>
        <a href="#" class="active"><i class="fas fa-user-graduate"></i> Student Search</a>
    </div>
    <div class="container">
        <h1>Admin Dashboard</h1>
        <p class="description">Search for a student by their ID to view all details submitted through the Student
            Support Dashboard. Download the data as a PDF for your records.</p>
        <div class="search-bar">
            <input type="text" id="student-id" placeholder="Enter Student ID" aria-label="Student ID">
            <button><i class="fas fa-search"></i> Search</button>
        </div>
        <div class="error-message" id="error-message">No student found with this ID.</div>
        <div class="student-details" id="student-details">
            <div class="detail-row" data-field="student_id"><label>Student ID</label><span
                    id="student-id-display"></span></div>
            <div class="detail-row" data-field="name"><label>Student Name</label><span id="name"></span></div>
            <div class="detail-row" data-field="course"><label>Course Name</label><span id="course"></span></div>
            <div class="detail-row" data-field="course_type"><label>Course Type</label><span id="course-type"></span>
            </div>
            <div class="detail-row" data-field="university_board"><label>University/Board</label><span
                    id="university-board"></span></div>
            <div class="detail-row" data-field="admission_date"><label>Date of Admission</label><span
                    id="admission-date"></span></div>
            <div class="detail-row" data-field="session"><label>Session</label><span id="session"></span></div>
            <div class="detail-row" data-field="exam_time"><label>Exam Time</label><span id="exam-time"></span></div>
            <div class="detail-row" data-field="father_name"><label>Father's Name</label><span id="father-name"></span>
            </div>
            <div class="detail-row" data-field="mother_name"><label>Mother's Name</label><span id="mother-name"></span>
            </div>
            <div class="detail-row" data-field="dob"><label>Date of Birth</label><span id="dob"></span></div>
            <div class="detail-row" data-field="present_address"><label>Present Address</label><span
                    id="present-address"></span></div>
            <div class="detail-row" data-field="permanent_address"><label>Permanent Address</label><span
                    id="permanent-address"></span></div>
            <div class="detail-row" data-field="contact_no"><label>Contact Number</label><span id="contact-no"></span>
            </div>
            <div class="detail-row" data-field="contact_no_2"><label>Contact Number 2</label><span
                    id="contact-no-2"></span></div>
            <div class="detail-row" data-field="email"><label>Email</label><span id="email"></span></div>
            <div class="detail-row" data-field="counsellor"><label>Name of Counsellor</label><span
                    id="counsellor"></span></div>
            <div class="detail-row" data-field="aadhar_no"><label>Aadhar Number</label><span id="aadhar-no"></span>
            </div>
            <div class="detail-row" data-field="status"><label>Status</label><span id="status"></span></div>
            <div class="detail-row" data-field="remarks"><label>Remarks</label><span id="remarks"></span></div>
            <div class="detail-row" data-field="university_regd_no"><label>University Registration Number</label><span
                    id="university-regd-no"></span></div>
            <div class="photo-row" data-field="photo"><label>Student Photo</label><img id="student-photo" src=""
                    alt="Student Photo"></div>
            <div class="detail-row" data-field="document"><label>Student Document</label><a id="student-document"
                    href="#" target="_blank">View Document</a></div>
            <div class="detail-row" data-field="additional_sheet"><label>Additional Sheet</label><a
                    id="additional-sheet" href="#" target="_blank">View Additional Sheet</a></div>
        </div>
        <a href="#" class="download-btn" id="download-btn">Download as PDF</a>
    </div>
    <script>
        const { jsPDF } = window.jspdf;
        const studentIdInput = document.getElementById("student-id");
        const searchButton = document.querySelector(".search-bar button");
        const studentDetails = document.getElementById("student-details");
        const errorMessage = document.getElementById("error-message");
        const downloadBtn = document.getElementById("download-btn");

        const fieldMap = {
            student_id: "Student ID",
            name: "Student Name",
            course: "Course Name",
            course_type: "Course Type",
            university_board: "University/Board",
            admission_date: "Date of Admission",
            session: "Session",
            exam_time: "Exam Time",
            father_name: "Father's Name",
            mother_name: "Mother's Name",
            dob: "Date of Birth",
            present_address: "Present Address",
            permanent_address: "Permanent Address",
            contact_no: "Contact Number",
            contact_no_2: "Contact Number 2",
            email: "Email",
            counsellor: "Name of Counsellor",
            aadhar_no: "Aadhar Number",
            status: "Status",
            remarks: "Remarks",
            university_regd_no: "University Registration Number",
            photo: "Student Photo",
            document: "Student Document",
            additional_sheet: "Additional Sheet"
        };

        // Helper function to format date as dd/mm/yyyy
        function formatDate(dateStr) {
            if (!dateStr || dateStr === "N/A") return "N/A";
            try {
                const date = new Date(dateStr);
                if (isNaN(date)) return "N/A";
                const day = String(date.getDate()).padStart(2, "0");
                const month = String(date.getMonth() + 1).padStart(2, "0");
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (error) {
                console.error("Error formatting date:", error);
                return "N/A";
            }
        }

        // Helper function to format time as hh:mm AM/PM
        function formatTime(timeStr) {
            if (!timeStr || timeStr === "N/A") return "N/A";
            try {
                const [hours, minutes] = timeStr.split(":").map(Number);
                if (isNaN(hours) || isNaN(minutes)) return "N/A";
                const period = hours >= 12 ? "PM" : "AM";
                const formattedHours = hours % 12 || 12;
                return `${formattedHours}:${String(minutes).padStart(2, "0")} ${period}`;
            } catch (error) {
                console.error("Error formatting time:", error);
                return "N/A";
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function getImageDataURL(url) {
            try {
                if (!url || url === "#" || url === "") return null;
                const response = await fetch(url, { mode: "cors" });
                if (!response.ok) throw new Error("Failed to fetch image");
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error fetching image:", error);
                return null;
            }
        }

        const fetchStudentData = debounce(async (studentId) => {
            if (!studentId) {
                errorMessage.style.display = "block";
                errorMessage.textContent = "Please enter a student ID.";
                studentDetails.style.display = "none";
                downloadBtn.style.display = "none";
                return;
            }

            try {
                const response = await fetch("/admin-show-data", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ student_id: studentId }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Student not found");
                }

                const studentData = await response.json();
                console.log("Received student data:", studentData);

                if (studentData) {
                    errorMessage.style.display = "none";
                    studentDetails.style.display = "flex";

                    const missingFields = [];
                    document.querySelectorAll(".detail-row, .photo-row").forEach(row => {
                        const field = row.getAttribute("data-field");
                        const span = row.querySelector("span");
                        const link = row.querySelector("a");
                        const img = row.querySelector("img");

                        let value = studentData[field] !== undefined && studentData[field] !== null ? studentData[field] : "N/A";

                        if (field === "admission_date" || field === "dob") {
                            value = formatDate(value);
                        } 
                      

                        console.log(`Rendering field: ${field}, value: ${value}`);

                        if (field === "photo" && img) {
                            img.src = value || "";
                        } else if (field === "document" && link) {
                            link.href = value || "#";
                            link.textContent = value && value !== "#" ? "View Document" : "No Document";
                        } else if (field === "additional_sheet" && link) {
                            link.href = value || "#";
                            link.textContent = value && value !== "#" ? "View Additional Sheet" : "No Additional Sheet";
                        } else if (span) {
                            span.textContent = value;
                        }

                        if (value === "N/A" && studentData[field] === undefined) {
                            missingFields.push(field);
                        }
                    });

                    if (missingFields.length > 0) {
                        console.warn("Missing fields in response:", missingFields);
                        errorMessage.style.display = "block";
                        errorMessage.textContent = `Warning: Missing fields - ${missingFields.join(", ")}`;
                    }

                    downloadBtn.style.display = "block";
                } else {
                    throw new Error("No student data returned");
                }
            } catch (error) {
                console.error("Error fetching student data:", error);
                errorMessage.style.display = "block";
                errorMessage.textContent = error.message || "No student found with this ID.";
                studentDetails.style.display = "none";
                downloadBtn.style.display = "none";
            }
        }, 300);

        studentIdInput.addEventListener("input", (e) => {
            if (e.target.value.trim()) {
                fetchStudentData(e.target.value.trim());
            }
        });

        searchButton.addEventListener("click", () => {
            fetchStudentData(studentIdInput.value.trim());
        });

        downloadBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            const doc = new jsPDF({
                orientation: "portrait",
                unit: "mm",
                format: "a4",
            });

            // Page dimensions and margins
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            const contentWidth = pageWidth - 2 * margin;
            const labelWidth = 60;
            const valueWidth = contentWidth - labelWidth - 40; // Adjusted for photo column
            let y = 15;

            // Header
            doc.setFillColor(59, 130, 246);
            doc.rect(0, 0, pageWidth, 20, 'F');
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.text("Student Details Report", margin, 12);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Student Support System", pageWidth - margin - 40, 12, { align: "right" });
            doc.setFontSize(8);
            doc.text("Institution Name", margin, 18);
            y += 10;

            // Subheader: Student ID and Date/Time
            doc.setFontSize(10);
            doc.setTextColor(30, 41, 59);
            doc.setFont("helvetica", "bold");
            doc.text(`Student ID: ${studentIdInput.value}`, margin, y);
            const currentDate = new Date();
            const formattedDate = formatDate(currentDate.toISOString().split("T")[0]);
            const formattedTime = formatTime(currentDate.toTimeString().split(" ")[0]);
            doc.text(`Generated: ${formattedDate} ${formattedTime}`, pageWidth - margin - 40, y, { align: "right" });
            y += 8;
            doc.setLineWidth(0.5);
            doc.setDrawColor(59, 130, 246);
            doc.line(margin, y, pageWidth - margin, y);
            y += 10;

            // Fetch student data
            let studentData;
            try {
                const response = await fetch("/admin-show-data", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ student_id: studentIdInput.value })
                });
                if (!response.ok) throw new Error("Failed to fetch student data");
                studentData = await response.json();
            } catch (error) {
                console.error("Error fetching student data for PDF:", error);
                return;
            }

            // Photo (Passport size: 35mm x 45mm)
            const photoUrl = document.getElementById("student-photo").src;
            const photoWidth = 35;
            const photoHeight = 45;
            const photoX = pageWidth - margin - photoWidth;
            const photoY = y;
            const photoDataUrl = await getImageDataURL(photoUrl);
            if (photoDataUrl) {
                try {
                    const img = new Image();
                    img.src = photoDataUrl;
                    await new Promise((resolve) => {
                        img.onload = resolve;
                    });
                    doc.addImage(photoDataUrl, "JPEG", photoX, photoY, photoWidth, photoHeight);
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(photoX, photoY, photoWidth, photoHeight);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text("Student Photo", photoX + photoWidth / 2, photoY + photoHeight + 5, { align: "center" });
                } catch (error) {
                    console.error("Error rendering photo:", error);
                    doc.setFont("helvetica", "italic");
                    doc.setTextColor(100, 116, 139);
                    doc.text("No Photo Available", photoX + photoWidth / 2, photoY + photoHeight / 2, { align: "center" });
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(photoX, photoY, photoWidth, photoHeight);
                }
            } else {
                doc.setFont("helvetica", "italic");
                doc.setTextColor(100, 116, 139);
                doc.text("No Photo Available", photoX + photoWidth / 2, photoY + photoHeight / 2, { align: "center" });
                doc.setLineWidth(0.2);
                doc.setDrawColor(200, 200, 200);
                doc.rect(photoX, photoY, photoWidth, photoHeight);
            }

            // Data Table
            y += 5;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(30, 41, 59);
            doc.setFillColor(230, 237, 250);
            doc.rect(margin, y, labelWidth, 8, 'F');
            doc.rect(margin + labelWidth, y, valueWidth, 8, 'F');
            doc.text("Field", margin + 2, y + 6);
            doc.text("Details", margin + labelWidth + 2, y + 6);
            doc.setLineWidth(0.2);
            doc.setDrawColor(100, 116, 139);
            doc.rect(margin, y, labelWidth, 8);
            doc.rect(margin + labelWidth, y, valueWidth, 8);
            y += 8;

            // Table Content
            doc.setFont("helvetica", "normal");
            let rowIndex = 0;
            const rowHeight = 8; // Fixed row height for consistency
            for (const [field, label] of Object.entries(fieldMap)) {
                // Skip photo field as it's handled separately
                if (field === "photo") continue;

                // Check for page overflow
                if (y + rowHeight > pageHeight - margin - 10) {
                    doc.addPage();
                    y = margin;
                    // Redraw header on new page
                    doc.setFillColor(59, 130, 246);
                    doc.rect(0, 0, pageWidth, 20, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(255, 255, 255);
                    doc.text("Student Details Report", margin, 12);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Student Support System", pageWidth - margin - 40, 12, { align: "right" });
                    doc.setFontSize(8);
                    doc.text("Institution Name", margin, 18);
                    y += 10;
                    // Redraw table header
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(30, 41, 59);
                    doc.setFillColor(230, 237, 250);
                    doc.rect(margin, y, labelWidth, 8, 'F');
                    doc.rect(margin + labelWidth, y, valueWidth, 8, 'F');
                    doc.text("Field", margin + 2, y + 6);
                    doc.text("Details", margin + labelWidth + 2, y + 6);
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(100, 116, 139);
                    doc.rect(margin, y, labelWidth, 8);
                    doc.rect(margin + labelWidth, y, valueWidth, 8);
                    y += 8;
                }

                let value = studentData[field] !== undefined && studentData[field] !== null ? studentData[field] : "N/A";
                if (field === "admission_date" || field === "dob") {
                    value = formatDate(value);
                } else if (field === "exam_time") {
                    value = formatTime(value);
                } else if (field === "document" || field === "additional_sheet") {
                    value = value && value !== "#" ? "Available (See Online)" : "Not Available";
                }

                const labelLines = doc.splitTextToSize(label, labelWidth - 4);
                const valueLines = doc.splitTextToSize(value.toString(), valueWidth - 4);
                const cellHeight = Math.max(labelLines.length, valueLines.length) * 5 + 4;

                // Use fixed row height for consistency, adjust if text is longer
                const actualRowHeight = Math.max(rowHeight, cellHeight);

                if (rowIndex % 2 === 0) {
                    doc.setFillColor(245, 247, 250);
                    doc.rect(margin, y, labelWidth, actualRowHeight, 'F');
                    doc.rect(margin + labelWidth, y, valueWidth, actualRowHeight, 'F');
                }

                doc.rect(margin, y, labelWidth, actualRowHeight);
                doc.rect(margin + labelWidth, y, valueWidth, actualRowHeight);
                doc.text(labelLines, margin + 2, y + 5);
                doc.text(valueLines, margin + labelWidth + 2, y + 5);

                y += actualRowHeight;
                rowIndex++;
            }

            // Footer
            doc.setLineWidth(0.5);
            doc.setDrawColor(59, 130, 246);
            doc.line(margin, pageHeight - margin - 5, pageWidth - margin, pageHeight - margin - 5);
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text("Generated by Student Support System", margin, pageHeight - margin);
            doc.text(`Page ${doc.getNumberOfPages()}`, pageWidth - margin - 20, pageHeight - margin, { align: "right" });

            doc.save(`student_${studentIdInput.value}_details.pdf`);
        });
    </script>
</body>

</html>